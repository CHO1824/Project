<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>í•‘í¬ ë³´ë“œ Pro â€” ì„œë²„ ì—†ì´ ë™ì‘</title>
<style>
:root{
  --bg:#fff6f9; --panel:#ffffff; --text:#3b2430; --muted:#7a5361; --border:#f5cfe0;
  --accent:#ff5894; --accent-2:#ff83b0; --ok:#22a06b; --danger:#ff5b7c; --warn:#ffb020;
  --shadow:0 12px 36px rgba(255,88,148,.18); --radius:16px
}
:root.dark{
  --bg:#1b1217; --panel:#251923; --text:#f5e9f0; --muted:#bd9fb0; --border:#3b2936;
  --accent:#ff5894; --accent-2:#ff83b0; --ok:#2fdc9a; --danger:#ff6f8a; --warn:#ffc46b;
  --shadow:0 12px 36px rgba(0,0,0,.45)
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;
  background:
    radial-gradient(900px 600px at 10% -10%, #ffe2ee40 0%, transparent 60%),
    radial-gradient(900px 600px at 120% 10%, #ffeaf340 0%, transparent 60%),
    var(--bg);
  color:var(--text)
}
.container{max-width:1100px;margin:26px auto;padding:0 16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;margin-bottom:14px}
.badge{display:inline-flex;gap:8px;align-items:center;background:#ffe4f1;color:#a43a63;border:1px dashed var(--border);padding:6px 12px;border-radius:999px;font-size:12px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;cursor:pointer;border-radius:12px;padding:9px 13px;font-weight:800;border:1px solid var(--border);background:linear-gradient(180deg,var(--accent),#ff3f87);color:#fff}
.btn.secondary{background:#ffe6f1;color:#6a3f53}
.btn.ghost{background:#fff;color:#6a3f53}
.btn.warn{background:var(--warn);color:#40220a;border-color:var(--warn)}
.btn.danger{background:var(--danger)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.switch{border:1px solid var(--border);background:#fff;border-radius:12px;padding:9px 13px;cursor:pointer}

.panel{padding:18px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
.input,.select{background:#fff;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:10px 12px;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s}
:root.dark .input,:root.dark .select{background:#2b1d28;color:var(--text)}
.input:focus,.select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,88,148,.18)}
.textarea{min-height:220px;resize:vertical}
.chip{display:inline-flex;align-items:center;gap:6px;background:#ffeaf3;color:#9a5d71;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
.empty{color:var(--muted);padding:26px;text-align:center}

table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
th{background:#fff0f6;color:#7a4a59}
tr:hover td{background:#fff7fb}
.row-item.selected td{background:#ffeef5!important}

.meta{display:flex;gap:12px;color:var(--muted);font-size:12px}
.title{font-size:22px;margin:0 0 8px}
.divider{height:1px;background:var(--border);margin:12px 0}

.pagination{display:flex;gap:6px;justify-content:center;padding:14px}
.page-btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.page-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.hidden{display:none!important}

/* íƒœê·¸ */
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{background:#ffeaf3;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:#9a5d71}

/* ì²¨ë¶€ ì´ë¯¸ì§€ */
.attach{display:flex;gap:10px;flex-wrap:wrap}
.thumb{width:100px;height:80px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
.thumb img{width:100%;height:100%;object-fit:cover}

/* ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ */
.cmt-wrap{display:grid;gap:12px}
.cmt-title{margin:0 0 4px;font-size:18px}
.cmt-list{display:grid;gap:8px}
.cmt-item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
.cmt-head{display:flex;gap:8px;align-items:center;justify-content:space-between;color:#7a4a59;font-size:12px}
.cmt-author{font-weight:700}
.cmt-body{white-space:pre-wrap;line-height:1.6;margin-top:6px}
.cmt-actions{display:flex;gap:6px}
.cmt-form{display:grid;gap:8px;border:1px dashed var(--border);padding:10px;border-radius:12px;background:#fffdfd}
.cmt-row{display:grid;grid-template-columns:1fr 120px;gap:8px}
.cmt-text{min-height:90px}
.reply{margin-left:24px;border-left:3px solid #ffd1e1;padding-left:10px;border-radius:6px}

/* íœ´ì§€í†µ */
.trash-note{font-size:12px;color:#9a5d71}
</style>
</head>
<body>
<div class="container">
  <div class="topbar card">
    <span class="badge">ğŸ’— í•‘í¬ ë³´ë“œ Pro Â· ì„œë²„/DB ì—†ì´ localStorageë¡œ ë™ì‘</span>
    <div class="actions">
      <button class="switch" id="toggleTheme">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
      <button class="btn" id="goWrite">ê¸€ì“°ê¸°</button>
      <button class="btn secondary" id="goList">ëª©ë¡</button>
      <button class="btn ghost" id="goTrash">íœ´ì§€í†µ</button>
      <button class="btn ghost" id="btnExport">ë‚´ë³´ë‚´ê¸°</button>
      <label class="btn ghost" for="importFile" style="cursor:pointer">ë¶ˆëŸ¬ì˜¤ê¸°</label>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
    </div>
  </div>

  <!-- ëª©ë¡ -->
  <section id="page-list" class="card panel">
    <div class="toolbar">
      <input id="search" class="input" placeholder="ê²€ìƒ‰(ì œëª©/ë‚´ìš©/ì‘ì„±ì/íƒœê·¸) [F]"/>
      <select id="sort" class="select">
        <option value="createdAt-desc">ìµœì‹ ìˆœ</option>
        <option value="createdAt-asc">ì˜¤ë˜ëœìˆœ</option>
        <option value="views-desc">ì¡°íšŒìˆ˜ ë†’ì€ìˆœ</option>
        <option value="title-asc">ì œëª© Aâ†’Z</option>
      </select>
      <select id="tagFilter" class="select"><option value="">ì „ì²´ íƒœê·¸</option></select>
      <span class="chip">í•€ ê³ ì • â†‘</span>
      <span class="chip">ë”ë¸”í´ë¦­ìœ¼ë¡œ ì—´ê¸°</span>
      <span class="chip">ë°ì´í„°: localStorage</span>
    </div>
    <div>
      <table>
        <thead>
          <tr>
            <th style="width:70px">ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th style="width:160px">ì‘ì„±ì</th>
            <th style="width:140px">ì‘ì„±ì¼</th>
            <th style="width:100px">ì¡°íšŒ</th>
            <th style="width:80px">í•€</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="hidden empty">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ <b>ê¸€ì“°ê¸°</b>ë¡œ ì‘ì„±í•´ë³´ì„¸ìš” âœ¨</div>
      <div class="pagination" id="pager"></div>
    </div>
  </section>

  <!-- ì—ë””í„° -->
  <section id="page-editor" class="card panel hidden">
    <h2 id="editorTitle" style="margin:0 0 10px">ìƒˆ ê¸€ ì‘ì„±</h2>
    <div class="toolbar"><span class="chip">âŒ˜/Ctrl+Enter ì €ì¥ Â· Esc ì·¨ì†Œ Â· ì´ˆì•ˆ ìë™ ì €ì¥</span></div>
    <div style="display:grid;gap:10px">
      <div style="display:grid;grid-template-columns:1fr 220px 100px;gap:10px">
        <input id="iptTitle" class="input" placeholder="ì œëª©"/>
        <input id="iptAuthor" class="input" placeholder="ì‘ì„±ì (ì„ íƒ)"/>
        <label style="display:flex;align-items:center;gap:6px">
          <input id="iptPinned" type="checkbox"/> í•€ ê³ ì •
        </label>
      </div>
      <input id="iptTags" class="input" placeholder="íƒœê·¸(ì‰¼í‘œë¡œ êµ¬ë¶„) ì˜ˆ: ê³µì§€,ì—…ë°ì´íŠ¸"/>
      <textarea id="iptContent" class="input textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸ í…ìŠ¤íŠ¸)"></textarea>

      <!-- ì²¨ë¶€ -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div class="chip">ì´ë¯¸ì§€ ì²¨ë¶€(ì„ íƒ)</div>
          <div style="display:flex;gap:8px;align-items:center">
            <label for="iptAttach" class="btn secondary" style="cursor:pointer">ì´ë¯¸ì§€ ì¶”ê°€</label>
            <input id="iptAttach" type="file" accept="image/*" style="display:none"/>
            <button class="btn ghost" id="btnClearAttach">ì²¨ë¶€ ë¹„ìš°ê¸°</button>
          </div>
        </div>
        <div id="attachWrap" class="attach" style="margin-top:8px"></div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnSave">ì €ì¥</button>
        <button class="btn secondary" id="btnCancel">ì·¨ì†Œ</button>
        <button class="btn danger hidden" id="btnDelete">ì‚­ì œ</button>
      </div>
    </div>
  </section>

  <!-- ìƒì„¸ -->
  <section id="page-view" class="card panel hidden">
    <h2 class="title" id="vTitle"></h2>
    <div class="meta">
      <span id="vAuthor"></span><span>â€¢</span>
      <span id="vDate"></span><span>â€¢</span>
      <span>ì¡°íšŒ <span id="vViews"></span></span>
    </div>
    <div class="tags" id="vTags" style="margin-top:6px"></div>
    <div class="divider"></div>
    <div id="vContent" style="white-space:pre-wrap;line-height:1.7"></div>
    <div id="vImages" class="attach" style="margin-top:10px"></div>

    <div class="divider"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnEdit">ìˆ˜ì •</button>
      <button class="btn warn" id="btnPinToggle">í•€ í† ê¸€</button>
      <button class="btn danger" id="btnMoveTrash">íœ´ì§€í†µìœ¼ë¡œ</button>
      <button class="btn secondary" id="btnBack">ëª©ë¡</button>
    </div>

    <div class="divider"></div>
    <!-- ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ -->
    <div class="cmt-wrap">
      <h3 class="cmt-title">ëŒ“ê¸€ <span id="cmtCount" style="font-size:14px;color:#9a5d71"></span></h3>
      <div id="cmtList" class="cmt-list"></div>
      <form id="cmtForm" class="cmt-form">
        <div class="cmt-row">
          <input id="cmtAuthor" class="input" placeholder="ì‘ì„±ì (ì„ íƒ, ë¯¸ì…ë ¥ ì‹œ ìµëª…)"/>
          <button class="btn" type="submit">ëŒ“ê¸€ ë“±ë¡</button>
        </div>
        <textarea id="cmtContent" class="input cmt-text" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <div class="chip">ëŒ€ëŒ“ê¸€: ëŒ“ê¸€ì˜ â€œë‹µê¸€â€ í´ë¦­</div>
      </form>
    </div>
  </section>

  <!-- íœ´ì§€í†µ -->
  <section id="page-trash" class="card panel hidden">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3 style="margin:0">íœ´ì§€í†µ</h3>
      <div class="actions">
        <button class="btn ghost" id="btnEmptyTrash">íœ´ì§€í†µ ë¹„ìš°ê¸°(ì™„ì „ì‚­ì œ)</button>
        <button class="btn secondary" id="btnBackList">ëª©ë¡</button>
      </div>
    </div>
    <div class="trash-note">â€» íœ´ì§€í†µì˜ ê¸€ì€ ì–¸ì œë“  ë³µì› ê°€ëŠ¥. ì™„ì „ì‚­ì œ ì‹œ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.</div>
    <div id="trashWrap" style="margin-top:10px"></div>
  </section>
</div>

<script>
/* ===== ìƒìˆ˜/í‚¤ ===== */
const DB_KEY='pink-board-pro-posts';
const UI_KEY='pink-board-pro-ui';
const DRAFT_KEY='pink-board-pro-draft';
const PAGE_SIZE=8;

/* ===== ìœ í‹¸ ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const debounce=(fn,ms=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
const fmtDate=ts=>{const d=new Date(ts);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`};
const escapeHtml=s=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const nl2br=s=>escapeHtml(s).replace(/\n/g,'<br>');
function toTags(str){return str.split(',').map(t=>t.trim()).filter(Boolean).slice(0,10);}
function unique(arr){return Array.from(new Set(arr));}

/* ===== ë°ì´í„° ê³„ì¸µ ===== */
const db={
  all(){ return JSON.parse(localStorage.getItem(DB_KEY)||'[]'); },
  save(list){ localStorage.setItem(DB_KEY, JSON.stringify(list)); },
  nextId(){ const l=this.all(); return l.length? Math.max(...l.map(p=>p.id))+1 : 1; },
  upsert(p){ const l=this.all(); const i=l.findIndex(x=>x.id===p.id); if(i>=0) l[i]=p; else l.push(p); this.save(l); },
  find(id){ return this.all().find(p=>p.id===id); },
  softRemove(id){ const p=this.find(id); if(!p) return; p.deletedAt=Date.now(); this.upsert(p); },
  restore(id){ const p=this.find(id); if(!p) return; delete p.deletedAt; this.upsert(p); },
  purge(ids){ this.save(this.all().filter(p=>!ids.includes(p.id))); },
  export(){ return JSON.stringify(this.all(),null,2); },
  import(json,mode='merge'){
    const arr=JSON.parse(json); if(!Array.isArray(arr)) throw new Error('JSON ë°°ì—´ì´ ì•„ë‹˜');
    if(mode==='replace'){ this.save(arr); return; }
    const map=new Map(this.all().map(p=>[p.id,p])); arr.forEach(p=>map.set(p.id,p)); this.save([...map.values()].sort((a,b)=>a.id-b.id));
  }
};

/* ===== í…Œë§ˆ ===== */
(function initTheme(){
  const ui=JSON.parse(localStorage.getItem(UI_KEY)||'{}');
  if(ui.theme==='dark') document.documentElement.classList.add('dark');
  $('#toggleTheme').textContent=document.documentElement.classList.contains('dark')?'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ':'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
})();
$('#toggleTheme').addEventListener('click',()=>{
  document.documentElement.classList.toggle('dark');
  const ui=JSON.parse(localStorage.getItem(UI_KEY)||'{}');
  ui.theme=document.documentElement.classList.contains('dark')?'dark':'light';
  localStorage.setItem(UI_KEY, JSON.stringify(ui));
  $('#toggleTheme').textContent=document.documentElement.classList.contains('dark')?'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ':'ğŸŒ™ ë‹¤í¬ëª¨ë“œ';
});

/* ===== ë¼ìš°íŒ… ===== */
const routes={ list:()=>showList(), write:()=>openEditor(), view:id=>openView(Number(id)), edit:id=>openEditor(Number(id)), trash:()=>openTrash() };
function navigate(path){ const next='#'+path; if(location.hash!==next) location.hash=next; handleRoute(); }
window.addEventListener('hashchange', handleRoute);
function hideAll(){ ['page-list','page-editor','page-view','page-trash'].forEach(id=>$('#'+id).classList.add('hidden')); }
function handleRoute(){ const [p,param]=location.hash.replace('#','').split('/'); hideAll(); (routes[p]||routes.list)(param); }

/* ===== ëª©ë¡ ===== */
let currentPage=1,currentQuery='',currentSort='createdAt-desc',currentTag='';
function showList(){
  $('#page-list').classList.remove('hidden');
  renderList();
  renderTagFilter();
}
function renderList(){
  const tbody=$('#tbody'), empty=$('#empty'), pager=$('#pager');
  let list=db.all().filter(p=>!p.deletedAt);

  if(currentQuery){
    const q=currentQuery.toLowerCase();
    list=list.filter(p=>{
      const hay=(p.title+p.content+(p.author||'')+(p.tags||[]).join(',')).toLowerCase();
      return hay.includes(q);
    });
  }
  if(currentTag){ list=list.filter(p=>(p.tags||[]).includes(currentTag)); }

  const [key,dir]=currentSort.split('-');
  list.sort((a,b)=>{
    // í•€ ìš°ì„ 
    if((b.pinned|0)!==(a.pinned|0)) return (b.pinned|0)-(a.pinned|0);
    const va=a[key]??'', vb=b[key]??'';
    if(va<vb) return dir==='asc'?-1:1;
    if(va>vb) return dir==='asc'?1:-1;
    return 0;
  });

  const total=list.length, pages=Math.max(1,Math.ceil(total/PAGE_SIZE));
  currentPage=Math.min(Math.max(1,currentPage),pages);
  const start=(currentPage-1)*PAGE_SIZE;
  const pageItems=list.slice(start,start+PAGE_SIZE);

  tbody.innerHTML=pageItems.map(p=>`
    <tr class="row-item" data-id="${p.id}" tabindex="0">
      <td>${p.id}</td>
      <td style="cursor:pointer;color:#b03967">
        ${p.pinned? 'ğŸ“Œ ': ''}${escapeHtml(p.title)}
        ${(p.tags&&p.tags.length)? p.tags.slice(0,3).map(t=>`<span class="tag" style="margin-left:6px">${escapeHtml(t)}</span>`).join(''):''}
      </td>
      <td>${escapeHtml(p.author||'ìµëª…')}</td>
      <td>${fmtDate(p.createdAt)}</td>
      <td>${p.views|0}</td>
      <td>${p.pinned? 'ê³ ì •': '-'}</td>
    </tr>
  `).join('');

  empty.classList.toggle('hidden', total>0);
  pager.innerHTML=Array.from({length:pages},(_,i)=>`<button class="page-btn ${i+1===currentPage?'active':''}" data-page="${i+1}">${i+1}</button>`).join('');

  $$('.row-item').forEach(tr=>{
    tr.addEventListener('click',()=>{ $$('.row-item').forEach(x=>x.classList.remove('selected')); tr.classList.add('selected'); });
    tr.addEventListener('dblclick',()=>navigate('view/'+tr.dataset.id));
    tr.addEventListener('keydown',e=>{ if(e.key==='Enter') navigate('view/'+tr.dataset.id); });
  });
  $$('.page-btn').forEach(b=> b.addEventListener('click',()=>{ currentPage=Number(b.dataset.page); renderList(); }));
}
function renderTagFilter(){
  const select=$('#tagFilter');
  const tags=unique(db.all().filter(p=>!p.deletedAt).flatMap(p=>p.tags||[])).sort();
  select.innerHTML='<option value="">ì „ì²´ íƒœê·¸</option>'+tags.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
  select.value=currentTag;
}

/* ===== ìƒì„¸ + ëŒ“ê¸€/ëŒ€ëŒ“ê¸€ ===== */
let currentId=null;
function openView(id){
  const p=db.find(id);
  if(!p || p.deletedAt){ alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸€ì…ë‹ˆë‹¤.'); return navigate('list'); }
  p.views=(p.views||0)+1; db.upsert(p);
  currentId=id;

  $('#vTitle').textContent=p.title;
  $('#vAuthor').textContent=p.author||'ìµëª…';
  $('#vDate').textContent=fmtDate(p.createdAt);
  $('#vViews').textContent=p.views;
  $('#vTags').innerHTML=(p.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
  $('#vContent').textContent=p.content;

  const imgWrap=$('#vImages');
  imgWrap.innerHTML=(p.images||[]).map(src=>`<div class="thumb"><img src="${src}" alt="attachment"></div>`).join('');

  renderComments(p);
  $('#page-view').classList.remove('hidden');
}

function renderComments(post){
  const listEl=$('#cmtList');
  const countEl=$('#cmtCount');
  const items=(post.comments||[]).slice().sort((a,b)=>a.createdAt-b.createdAt);
  countEl.textContent=`(${items.length})`;

  // íŠ¸ë¦¬ êµ¬ì„±
  const byParent=new Map(); items.forEach(c=>{ const k=c.parentId||0; if(!byParent.has(k)) byParent.set(k,[]); byParent.get(k).push(c); });
  const makeHtml=(pid,depth=0)=> (byParent.get(pid)||[]).map(c=>`
    <div class="cmt-item ${c.parentId? 'reply':''}" data-cid="${c.id}">
      <div class="cmt-head">
        <div><span class="cmt-author">${escapeHtml(c.author||'ìµëª…')}</span> Â· <span>${fmtDate(c.createdAt)}</span></div>
        <div class="cmt-actions">
          <button class="page-btn" data-act="reply">ë‹µê¸€</button>
          <button class="page-btn" data-act="edit">ìˆ˜ì •</button>
          <button class="page-btn" data-act="delete" style="color:#c62828">ì‚­ì œ</button>
        </div>
      </div>
      <div class="cmt-body">${nl2br(c.content||'')}</div>
      ${makeHtml(c.id, depth+1).join('')}
    </div>
  `);

  listEl.innerHTML = makeHtml(0).join('');

  // ì´ë²¤íŠ¸
  $$('#cmtList .cmt-item .page-btn').forEach(btn=>{
    const act=btn.dataset.act;
    btn.addEventListener('click',()=>{
      const cid=Number(btn.closest('.cmt-item').dataset.cid);
      if(act==='delete'){
        if(confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){
          const p=db.find(currentId); p.comments=(p.comments||[]).filter(x=>x.id!==cid && x.parentId!==cid); db.upsert(p); renderComments(p);
        }
      }
      if(act==='edit'){
        const p=db.find(currentId); const c=(p.comments||[]).find(x=>x.id===cid); if(!c) return;
        const edited=prompt('ëŒ“ê¸€ ìˆ˜ì •', c.content); if(edited==null) return;
        const t=edited.trim(); if(!t){ if(confirm('ë¹ˆ ë‚´ìš©ì…ë‹ˆë‹¤. ì‚­ì œí• ê¹Œìš”?')){ p.comments=p.comments.filter(x=>x.id!==cid && x.parentId!==cid); db.upsert(p); renderComments(p);} return; }
        c.content=t; db.upsert(p); renderComments(p);
      }
      if(act==='reply'){
        const author=prompt('ì‘ì„±ì(ë¯¸ì…ë ¥ì‹œ ìµëª…)')||'ìµëª…';
        const content=prompt('ë‹µê¸€ ë‚´ìš©'); if(!content) return;
        const p=db.find(currentId); if(!Array.isArray(p.comments)) p.comments=[];
        const nid = (p.comments.length? Math.max(...p.comments.map(x=>x.id))+1:1);
        p.comments.push({id:nid,parentId:cid,author,content,createdAt:Date.now()}); db.upsert(p); renderComments(p);
      }
    });
  });

  // ë“±ë¡ í¼
  const form=$('#cmtForm'); const aEl=$('#cmtAuthor'); const cEl=$('#cmtContent');
  form.onsubmit=(e)=>{ e.preventDefault(); if(!cEl.value.trim()){ alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } const p=db.find(currentId); if(!Array.isArray(p.comments)) p.comments=[]; const nid=(p.comments.length? Math.max(...p.comments.map(x=>x.id))+1:1); p.comments.push({id:nid,parentId:0,author:aEl.value.trim()||'ìµëª…',content:cEl.value.trim(),createdAt:Date.now()}); db.upsert(p); cEl.value=''; renderComments(p); };
}

/* ===== ì—ë””í„° ===== */
const iptTitle=$('#iptTitle'),iptAuthor=$('#iptAuthor'),iptContent=$('#iptContent'),iptTags=$('#iptTags'),iptPinned=$('#iptPinned');
const iptAttach=$('#iptAttach'), attachWrap=$('#attachWrap');
let btnSave=$('#btnSave'), btnDelete=$('#btnDelete');
function openEditor(id){
  const edit=!!id; $('#page-editor').classList.remove('hidden');
  $('#editorTitle').textContent=edit?'ê¸€ ìˆ˜ì •':'ìƒˆ ê¸€ ì‘ì„±';
  btnSave.replaceWith(btnSave.cloneNode(true)); btnDelete.replaceWith(btnDelete.cloneNode(true)); btnSave=$('#btnSave'); btnDelete=$('#btnDelete');

  let images=[];
  function renderAttach(){ attachWrap.innerHTML = images.map((src,i)=>`<div class="thumb" title="í´ë¦­í•´ ì œê±°" data-i="${i}"><img src="${src}"/></div>`).join(''); $$('#attachWrap .thumb').forEach(t=>t.addEventListener('click',()=>{ images.splice(Number(t.dataset.i),1); renderAttach(); })); }

  if(edit){
    const p=db.find(Number(id)); if(!p || p.deletedAt){ alert('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return navigate('list'); }
    iptTitle.value=p.title; iptAuthor.value=p.author||''; iptContent.value=p.content; iptTags.value=(p.tags||[]).join(','); iptPinned.checked=!!p.pinned;
    images = (p.images||[]).slice(); renderAttach();
    btnDelete.classList.remove('hidden'); btnDelete.onclick=()=>{ if(confirm('ì´ ê¸€ì„ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í• ê¹Œìš”?')){ db.softRemove(p.id); navigate('list'); renderList(); } };
    btnSave.onclick=()=> savePost(p.id, images);
  }else{
    const draft=JSON.parse(localStorage.getItem(DRAFT_KEY)||'null');
    if(draft && confirm('ì´ì „ì— ì‘ì„± ì¤‘ì¸ ì´ˆì•ˆì„ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?')){ iptTitle.value=draft.title||''; iptAuthor.value=draft.author||''; iptContent.value=draft.content||''; iptTags.value=draft.tags||''; iptPinned.checked=!!draft.pinned; images=draft.images||[]; }
    else { iptTitle.value=''; iptAuthor.value=''; iptContent.value=''; iptTags.value=''; iptPinned.checked=false; images=[]; }
    renderAttach();
    btnDelete.classList.add('hidden');
    btnSave.onclick=()=> savePost(null, images);
  }

  // ì²¨ë¶€ ì¶”ê°€
  iptAttach.onchange=(ev)=>{
    const f=ev.target.files?.[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=()=>{ images.push(reader.result); renderAttach(); saveDraft(); };
    reader.readAsDataURL(f); ev.target.value='';
  };
  $('#btnClearAttach').onclick=()=>{ images=[]; renderAttach(); saveDraft(); };

  // ìë™ ì´ˆì•ˆ ì €ì¥
  [iptTitle,iptAuthor,iptContent,iptTags,iptPinned].forEach(el=> el.addEventListener('input', debounce(saveDraft,300)));
  function saveDraft(){
    localStorage.setItem(DRAFT_KEY, JSON.stringify({ title:iptTitle.value, author:iptAuthor.value, content:iptContent.value, tags:iptTags.value, pinned:iptPinned.checked, images }));
  }
}

/* ê²€ì¦ + ì €ì¥ */
function validate(title, content){
  if(!title||!content){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
  if(title.length>140){ alert('ì œëª©ì€ 140ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
  return true;
}
function savePost(id, images){
  const title=iptTitle.value.trim(); const author=iptAuthor.value.trim()||'ìµëª…'; const content=iptContent.value.trim();
  const tags=toTags(iptTags.value); const pinned=iptPinned.checked;
  if(!validate(title,content)) return;
  const now=Date.now();
  if(id){
    const p=db.find(id); if(!p) return;
    db.upsert({...p,title,author,content,tags,pinned,images,updatedAt:now});
    localStorage.removeItem(DRAFT_KEY);
    renderList(); navigate('view/'+id);
  }else{
    const newId=db.nextId();
    db.upsert({id:newId,title,author,content,tags,pinned,images,createdAt:now,updatedAt:now,views:0,comments:[]});
    localStorage.removeItem(DRAFT_KEY);
    renderList(); navigate('view/'+newId);
  }
}

/* ===== íœ´ì§€í†µ ===== */
function openTrash(){
  $('#page-trash').classList.remove('hidden');
  const wrap=$('#trashWrap');
  const list=db.all().filter(p=>p.deletedAt).sort((a,b)=>b.deletedAt-a.deletedAt);
  wrap.innerHTML = list.length? list.map(p=>`
    <div class="card panel" style="margin-bottom:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:800">${escapeHtml(p.title)}</div>
          <div class="meta"><span>${escapeHtml(p.author||'ìµëª…')}</span> Â· <span>ì‚­ì œì¼ ${fmtDate(p.deletedAt)}</span> Â· <span>ID ${p.id}</span></div>
        </div>
        <div class="actions">
          <button class="btn secondary" data-act="restore" data-id="${p.id}">ë³µì›</button>
          <button class="btn danger" data-act="purge" data-id="${p.id}">ì™„ì „ì‚­ì œ</button>
        </div>
      </div>
    </div>
  `).join('') : '<div class="empty">íœ´ì§€í†µì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>';

  wrap.querySelectorAll('button').forEach(b=>{
    const id=Number(b.dataset.id);
    if(b.dataset.act==='restore') b.addEventListener('click',()=>{ db.restore(id); openTrash(); });
    if(b.dataset.act==='purge') b.addEventListener('click',()=>{ if(confirm('ì •ë§ ì™„ì „ì‚­ì œí• ê¹Œìš”?')){ db.purge([id]); openTrash(); }});
  });
}

/* ===== ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ===== */
$('#btnExport').addEventListener('click',()=>{
  const blob=new Blob([db.export()],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='board-pro.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#importFile').addEventListener('change',ev=>{
  const f=ev.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const mode=confirm('í™•ì¸=ë®ì–´ì“°ê¸°(ëª¨ë“  ë°ì´í„° êµì²´)\nì·¨ì†Œ=ë³‘í•©(ê¸°ì¡´ì— í•©ì¹˜ê¸°)');
      db.import(reader.result, mode?'replace':'merge');
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!'); navigate('list'); renderList(); renderTagFilter();
    }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSONì´ ì•„ë‹™ë‹ˆë‹¤.'); }
  };
  reader.readAsText(f,'utf-8'); ev.target.value='';
});

/* ===== ìƒë‹¨ ë²„íŠ¼ ===== */
$('#goWrite').addEventListener('click',()=>navigate('write'));
$('#goList').addEventListener('click',()=>navigate('list'));
$('#goTrash').addEventListener('click',()=>navigate('trash'));
$('#btnBackList').addEventListener('click',()=>navigate('list'));

/* ===== ìƒì„¸ ë²„íŠ¼ ===== */
$('#btnBack').addEventListener('click',()=>navigate('list'));
$('#btnEdit').addEventListener('click',()=>{ if(currentId!=null) navigate('edit/'+currentId); });
$('#btnMoveTrash').addEventListener('click',()=>{ if(currentId==null) return; if(confirm('ì´ ê¸€ì„ íœ´ì§€í†µìœ¼ë¡œ ì´ë™í• ê¹Œìš”?')){ db.softRemove(currentId); navigate('list'); renderList(); }});
$('#btnPinToggle').addEventListener('click',()=>{ if(currentId==null) return; const p=db.find(currentId); if(!p) return; p.pinned=!p.pinned; db.upsert(p); openView(currentId); renderList(); });

/* ===== ëª©ë¡ ê²€ìƒ‰/í•„í„°/ì •ë ¬ ===== */
$('#search').addEventListener('input',debounce(e=>{ currentQuery=e.target.value; currentPage=1; renderList(); },250));
$('#sort').addEventListener('change',e=>{ currentSort=e.target.value; renderList(); });
$('#tagFilter').addEventListener('change',e=>{ currentTag=e.target.value; currentPage=1; renderList(); });

/* ===== íœ´ì§€í†µ ë¹„ìš°ê¸° ===== */
$('#btnEmptyTrash').addEventListener('click',()=>{
  const ids=db.all().filter(p=>p.deletedAt).map(p=>p.id);
  if(!ids.length) return alert('ë¹„ìš¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
  if(confirm(`íœ´ì§€í†µì˜ ${ids.length}ê°œ í•­ëª©ì„ ì™„ì „ì‚­ì œí• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)){ db.purge(ids); openTrash(); }
});

/* ===== ë‹¨ì¶•í‚¤ ===== */
document.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k==='n'){ navigate('write'); }
  if(k==='e' && !$('#page-view').classList.contains('hidden')) $('#btnEdit').click();
  if(k==='l'){ navigate('list'); }
  if(k==='f'){ $('#search').focus(); e.preventDefault(); }
});

/* ===== ì´ˆê¸° ì‹œë“œ ===== */
(function seed(){
  if(db.all().length) return;
  const now=Date.now();
  db.save([
    {id:1,title:'í•‘í¬ ë³´ë“œ Pro ì‹œì‘í•˜ê¸° ğŸ’—',author:'ê´€ë¦¬ì',content:'ì´ ê²Œì‹œíŒì€ ì„œë²„ ì—†ì´ localStorageë¡œ ë™ì‘í•©ë‹ˆë‹¤.\ní•€/íƒœê·¸/ì´ë¯¸ì§€/ëŒ“ê¸€/íœ´ì§€í†µ/ë‹¤í¬ëª¨ë“œê¹Œì§€!',tags:['ê³µì§€','ê°€ì´ë“œ'],pinned:true,images:[],createdAt:now-86400000*2,updatedAt:now-86400000*2,views:10,comments:[]},
    {id:2,title:'ì—…ë°ì´íŠ¸ ë…¸íŠ¸',author:'ê´€ë¦¬ì',content:'- í•€ ê³ ì •\n- íƒœê·¸ í•„í„°\n- ì´ë¯¸ì§€ ì²¨ë¶€\n- ëŒ€ëŒ“ê¸€/íœ´ì§€í†µ',tags:['ì—…ë°ì´íŠ¸'],pinned:false,images:[],createdAt:now-86400000,updatedAt:now-86400000,views:6,comments:[]}
  ]);
})();

/* ===== ì´ˆê¸° ì§„ì… ===== */
if(!location.hash) navigate('list'); else handleRoute();
window.addEventListener('load',()=>handleRoute());
</script>
</body>
</html>
