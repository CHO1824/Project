<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í•‘í¬ ê²Œì‹œíŒ â€” ì„œë²„/DB ì—†ì´ ì™„ì „ CRUD</title>
  <style>
    :root{
      --bg:#fff5f8; --panel:#ffffff; --accent:#ff5894; --accent-2:#ff83b0; --border:#f7c6d7;
      --text:#4a2836; --muted:#7a5361; --danger:#ff4d6d; --ok:#2fa36e;
      --radius:16px; --shadow:0 10px 30px rgba(255,88,148,.18)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;background:radial-gradient(1000px 600px at 20% -10%, #ffe0ec 0%, transparent 60%),radial-gradient(1000px 600px at 120% 10%, #ffeef5 0%, transparent 60%),var(--bg);color:var(--text)}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;margin-bottom:14px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#ffe1ef;color:#b03c69;padding:6px 12px;border-radius:999px;font-size:12px;border:1px dashed var(--border)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:800;border:1px solid var(--border);background:linear-gradient(180deg,var(--accent),#ff3f87);color:#fff}
    .btn:hover{filter:brightness(1.06)}
    .btn.secondary{background:#ffe6f1;color:#6a3f53}
    .btn.ghost{background:#fff;color:#6a3f53}
    .btn.danger{background:#ff6b8a}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .panel{padding:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input,.select{background:#fff;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:10px 12px;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s}
    .input:focus,.select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,88,148,.18)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#fff0f6;color:#7a4a59}
    tr:hover td{background:#fff7fb}
    .row-item.selected td{background:#ffeef5 !important}
    .empty{color:var(--muted);padding:26px;text-align:center}

    .pagination{display:flex;gap:6px;justify-content:center;padding:14px}
    .page-btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .page-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .hidden{display:none!important}

    .meta{display:flex;gap:12px;color:#7a5361;font-size:12px}
    .title{font-size:22px;margin:0 0 8px}
    .divider{height:1px;background:var(--border);margin:12px 0}

    .notice{font-size:12px;color:#9a5d71;background:#fff0f6;border:1px dashed var(--border);padding:8px 10px;border-radius:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#ffeaf3;color:#9a5d71;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}

    /* ëŒ“ê¸€ */
    .cmt-wrap{display:grid;gap:12px}
    .cmt-title{margin:0 0 4px;font-size:18px}
    .cmt-list{display:grid;gap:8px}
    .cmt-item{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .cmt-head{display:flex;gap:8px;align-items:center;justify-content:space-between;color:#7a4a59;font-size:12px}
    .cmt-author{font-weight:700}
    .cmt-date{opacity:.8}
    .cmt-body{white-space:pre-wrap;line-height:1.6;margin-top:6px}
    .cmt-actions{display:flex;gap:6px}
    .cmt-form{display:grid;gap:8px;border:1px dashed var(--border);padding:10px;border-radius:12px;background:#fffdfd}
    .cmt-row{display:grid;grid-template-columns:1fr 120px;gap:8px}
    .cmt-text{min-height:90px}

    /* ì²´í¬ë°•ìŠ¤ ì—´ */
    .col-check{width:38px}
    .row-check{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar card">
      <span class="badge">ğŸ’— í•‘í¬ ê²Œì‹œíŒ</span>
      <div class="actions">
        <button class="btn" id="goWrite">ê¸€ì“°ê¸°</button>
        <button class="btn secondary" id="goList">ëª©ë¡</button>
        <button class="btn danger" id="btnBulkDelete" title="ì„ íƒí•œ ê¸€ ì‚­ì œ" disabled>ì„ íƒ ì‚­ì œ</button>
        <button class="btn ghost" id="btnExport" title="JSON ë‚´ë³´ë‚´ê¸°">ë‚´ë³´ë‚´ê¸°</button>
        <label class="btn ghost" title="JSON ë¶ˆëŸ¬ì˜¤ê¸°" for="importFile" style="cursor:pointer">ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <!-- ëª©ë¡ -->
    <section id="page-list" class="card panel">
      <div class="toolbar">
        <input id="search" class="input" placeholder="ê²€ìƒ‰(ì œëª©/ë‚´ìš©/ì‘ì„±ì)" />
        <select id="sort" class="select">
          <option value="createdAt-desc">ìµœì‹ ìˆœ</option>
          <option value="createdAt-asc">ì˜¤ë˜ëœìˆœ</option>
          <option value="views-desc">ì¡°íšŒìˆ˜ ë†’ì€ìˆœ</option>
          <option value="title-asc">ì œëª© Aâ†’Z</option>
        </select>
        <span class="chip">ì²´í¬ â†’ ì„ íƒ ì‚­ì œ</span>
        <span class="chip">ë”ë¸”í´ë¦­ìœ¼ë¡œ ì—´ê¸°</span>
      </div>
      <div id="listWrap">
        <table>
          <thead>
            <tr>
              <th class="col-check"><input type="checkbox" id="chkAll" /></th>
              <th style="width:70px">ë²ˆí˜¸</th>
              <th>ì œëª©</th>
              <th style="width:160px">ì‘ì„±ì</th>
              <th style="width:140px">ì‘ì„±ì¼</th>
              <th style="width:100px">ì¡°íšŒ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="hidden empty">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ <b>ê¸€ì“°ê¸°</b>ë¡œ ì‘ì„±í•´ë³´ì„¸ìš” âœ¨</div>
        <div class="pagination" id="pager"></div>
      </div>
    </section>

    <!-- ì—ë””í„° -->
    <section id="page-editor" class="card panel hidden">
      <h2 id="editorTitle" style="margin:0 0 10px">ìƒˆ ê¸€ ì‘ì„±</h2>
      <div class="editor">
        <div class="toolbar" style="margin:0 0 10px 0">
          <span class="notice">âŒ˜/Ctrl+Enter ì €ì¥, Esc ì·¨ì†Œ Â· ì´ˆì•ˆ ìë™ ì €ì¥</span>
        </div>
        <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <input id="iptTitle" class="input" placeholder="ì œëª©" />
          <input id="iptAuthor" class="input" placeholder="ì‘ì„±ì (ì„ íƒ)" />
        </div>
        <textarea id="iptContent" class="input" style="min-height:240px;resize:vertical" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnSave">ì €ì¥</button>
          <button class="btn secondary" id="btnCancel">ì·¨ì†Œ</button>
          <button class="btn danger hidden" id="btnDelete">ì‚­ì œ</button>
        </div>
      </div>
    </section>

    <!-- ìƒì„¸ -->
    <section id="page-view" class="card panel hidden">
      <h2 class="title" id="vTitle"></h2>
      <div class="meta">
        <span id="vAuthor"></span>
        <span>â€¢</span>
        <span id="vDate"></span>
        <span>â€¢</span>
        <span>ì¡°íšŒ <span id="vViews"></span></span>
      </div>
      <div class="divider"></div>
      <div id="vContent" style="white-space:pre-wrap;line-height:1.7"></div>
      <div class="divider"></div>

      <!-- ëŒ“ê¸€ -->
      <div class="cmt-wrap">
        <h3 class="cmt-title">ëŒ“ê¸€ <span id="cmtCount" style="font-size:14px;color:#9a5d71"></span></h3>
        <div id="cmtList" class="cmt-list"></div>
        <form id="cmtForm" class="cmt-form">
          <div class="cmt-row">
            <input id="cmtAuthor" class="input" placeholder="ì‘ì„±ì (ì„ íƒ, ë¯¸ì…ë ¥ ì‹œ ìµëª…)" />
            <button class="btn" id="cmtSubmit" type="submit">ëŒ“ê¸€ ë“±ë¡</button>
          </div>
          <textarea id="cmtContent" class="input cmt-text" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <div class="notice">âŒ˜/Ctrl+Enter ë¡œ ë¹ ë¥´ê²Œ ë“±ë¡</div>
        </form>
      </div>

      <div class="divider"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnEdit">ìˆ˜ì •</button>
        <button class="btn danger" id="btnDeleteView">ì‚­ì œ</button>
        <button class="btn secondary" id="btnBack">ëª©ë¡</button>
      </div>
    </section>
  </div>

  <script>
    /* ===== ìƒìˆ˜/í‚¤ ===== */
    const DB_KEY = 'pink-board-v3';
    const DRAFT_KEY = 'pink-board-v3-draft';
    const UI_KEY = 'pink-board-v3-ui';
    const PAGE_SIZE = 8;

    /* ===== ìœ í‹¸ ===== */
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const debounce = (fn,ms=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
    const fmtDate = ts => { const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    const fmtDateTime = ts => { const d=new Date(ts); return `${fmtDate(ts)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };
    const escapeHtml = s => s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const nl2br = s => escapeHtml(s).replace(/\n/g,'<br>');

    /* ===== DB ê³„ì¸µ(localStorage) ===== */
    const db = {
      all(){ return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); },
      save(list){ localStorage.setItem(DB_KEY, JSON.stringify(list)); },
      nextId(){ const list=this.all(); return list.length? Math.max(...list.map(p=>p.id))+1 : 1; },
      find(id){ return this.all().find(p=>p.id===id); },
      upsert(post){ const list=this.all(); const i=list.findIndex(p=>p.id===post.id); if(i>=0) list[i]=post; else list.push(post); this.save(list); },
      remove(id){ this.save(this.all().filter(p=>p.id!==id)); },
      export(){ return JSON.stringify(this.all(), null, 2); },
      import(json,mode='merge'){ // 'replace' or 'merge'
        const incoming = JSON.parse(json);
        if(!Array.isArray(incoming)) throw new Error('JSON ë°°ì—´ì´ ì•„ë‹˜');
        if(mode==='replace'){ this.save(incoming); return; }
        const map = new Map(this.all().map(p=>[p.id,p]));
        for(const p of incoming){ map.set(p.id,p); }
        this.save([...map.values()].sort((a,b)=>a.id-b.id));
      }
    };

    /* ===== ì´ˆê¸° ë°ì´í„° ì‹œë“œ ===== */
    (function seed(){
      if(db.all().length) return;
      const now=Date.now();
      db.save([
        {id:1,title:'í•‘í¬ ê²Œì‹œíŒì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤ ğŸ’—',author:'ê´€ë¦¬ì',content:'ì´ ê²Œì‹œíŒì€ ì„œë²„ ì—†ì´ localStorageë§Œìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.\nìƒë‹¨ ê¸€ì“°ê¸°ë¥¼ ëˆŒëŸ¬ ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!',createdAt:now-86400000*2,updatedAt:now-86400000*2,views:11,comments:[]},
        {id:2,title:'ê¸°ëŠ¥ ì†Œê°œ',author:'ê´€ë¦¬ì',content:'ê²€ìƒ‰Â·ì •ë ¬Â·í˜ì´ì§• Â· ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° Â· ì™„ì „ CRUD Â· ëŒ“ê¸€',createdAt:now-86400000,updatedAt:now-86400000,views:7,comments:[]}
      ]);
    })();

    /* ===== ë¼ìš°íŒ… ===== */
    const routes = { list:()=>showList(), write:()=>openEditor(), view:id=>openView(Number(id)), edit:id=>openEditor(Number(id)) };
    function navigate(path){
      const next = '#'+path;
      if(location.hash!==next) location.hash = next;
      handleRoute(); // ì¦‰ì‹œ ì²˜ë¦¬
    }
    window.addEventListener('hashchange', handleRoute);
    function handleRoute(){
      const [page,param] = location.hash.replace('#','').split('/');
      hideAll(); (routes[page]||routes.list)(param);
    }
    function hideAll(){ ['page-list','page-editor','page-view'].forEach(id=>$( '#'+id ).classList.add('hidden')); }

    /* ===== ëª©ë¡ ===== */
    let currentPage=1, currentQuery='', currentSort='createdAt-desc', selectedRow=null;
    restoreUI();

    // ë‹¤ì¤‘ ì„ íƒ ìƒíƒœ
    let selectedIds = new Set();

    function showList(){ $('#page-list').classList.remove('hidden'); renderList(); }

    function renderList(){
      const tbody=$('#tbody'), empty=$('#empty'), pager=$('#pager');
      let list = db.all();

      if(currentQuery){
        const q=currentQuery.toLowerCase();
        list = list.filter(p => (p.title+p.content+(p.author||'')).toLowerCase().includes(q));
      }

      const [key,dir] = currentSort.split('-');
      list.sort((a,b)=>{
        const va=a[key]??'', vb=b[key]??'';
        if(va<vb) return dir==='asc'?-1:1;
        if(va>vb) return dir==='asc'?1:-1;
        return 0;
      });

      const total=list.length, pages=Math.max(1, Math.ceil(total/PAGE_SIZE));
      currentPage = Math.min(Math.max(1,currentPage), pages);
      const start=(currentPage-1)*PAGE_SIZE;
      const pageItems=list.slice(start,start+PAGE_SIZE);

      tbody.innerHTML = pageItems.map(p=>`
        <tr data-id="${p.id}" class="row-item" tabindex="0">
          <td class="row-check"><input type="checkbox" class="chk" data-id="${p.id}" ${selectedIds.has(p.id)?'checked':''} /></td>
          <td>${p.id}</td>
          <td style="cursor:pointer;color:#b03967">${escapeHtml(p.title)}</td>
          <td>${escapeHtml(p.author||'ìµëª…')}</td>
          <td>${fmtDate(p.createdAt)}</td>
          <td>${p.views|0}</td>
        </tr>
      `).join('');

      empty.classList.toggle('hidden', total>0);
      pager.innerHTML = Array.from({length:pages},(_,i)=>`<button class="page-btn ${i+1===currentPage?'active':''}" data-page="${i+1}">${i+1}</button>`).join('');

      // ì²´í¬ë°•ìŠ¤
      const chkAll = $('#chkAll');
      const pageChecks = $$('.chk');

      // ê°œë³„ ì²´í¬
      pageChecks.forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const id = Number(chk.dataset.id);
          if(chk.checked) selectedIds.add(id); else selectedIds.delete(id);
          updateBulkDeleteState();
          // í˜ì´ì§€ ë‚´ ëª¨ë“  í•­ëª©ì´ ì²´í¬ëëŠ”ì§€ ë°˜ì˜
          chkAll.checked = pageChecks.every(c=>c.checked);
        });
      });

      // í–‰ ì„ íƒ í•˜ì´ë¼ì´íŠ¸/ì—´ê¸°
      $$('.row-item').forEach(tr=>{
        tr.addEventListener('click', (e)=>{
          // ì²´í¬ë°•ìŠ¤ í´ë¦­ì€ ë¬´ì‹œ
          if(e.target.classList.contains('chk')) return;
          if(selectedRow) selectedRow.classList.remove('selected');
          tr.classList.add('selected'); selectedRow=tr;
        });
        tr.addEventListener('dblclick', (e)=>{
          if(e.target.classList.contains('chk')) return;
          navigate('view/'+tr.dataset.id);
        });
        tr.addEventListener('keydown', e=>{ if(e.key==='Enter') navigate('view/'+tr.dataset.id); });
      });

      // í˜ì´ì§€ ë²„íŠ¼
      $$('.page-btn').forEach(b=> b.addEventListener('click', ()=>{ currentPage=Number(b.dataset.page); saveUI(); renderList(); }));

      // ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
      chkAll.checked = pageChecks.length>0 && pageChecks.every(c=>c.checked);

      updateBulkDeleteState();
      saveUI();
    }

    function updateBulkDeleteState(){
      const btn = $('#btnBulkDelete');
      btn.disabled = selectedIds.size===0;
      btn.textContent = selectedIds.size ? `ì„ íƒ ì‚­ì œ (${selectedIds.size})` : 'ì„ íƒ ì‚­ì œ';
    }

    // ì„ íƒ ì‚­ì œ ì‹¤í–‰
    $('#btnBulkDelete').addEventListener('click', ()=>{
      if(selectedIds.size===0) return;
      const ids = Array.from(selectedIds).sort((a,b)=>a-b);
      if(!confirm(`ì„ íƒí•œ ${ids.length}ê°œ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      ids.forEach(id=> db.remove(id));
      // í˜„ì¬ ë³´ê³  ìˆë˜ ê¸€ì´ ì‚­ì œëë‹¤ë©´ ëª©ë¡ìœ¼ë¡œ
      if(currentId && selectedIds.has(currentId)) navigate('list');
      selectedIds.clear();
      renderList();
      alert('ì‚­ì œ ì™„ë£Œ!');
    });

    // ì „ì²´ì„ íƒ í† ê¸€
    $('#chkAll').addEventListener('change', (e)=>{
      const pageChecks = $$('.chk');
      if(e.target.checked){
        pageChecks.forEach(c=> selectedIds.add(Number(c.dataset.id)));
      }else{
        pageChecks.forEach(c=> selectedIds.delete(Number(c.dataset.id)));
      }
      renderList(); // ì²´í¬ ìƒíƒœ ì¬ë°˜ì˜
    });

    /* ===== ìƒì„¸ & ëŒ“ê¸€ ===== */
    let currentId=null;

    function openView(id){
      const post = db.find(id);
      if(!post){ alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸€ì…ë‹ˆë‹¤.'); return navigate('list'); }
      post.views = (post.views||0)+1;
      if(!Array.isArray(post.comments)) post.comments = [];
      db.upsert(post);

      $('#vTitle').textContent = post.title;
      $('#vAuthor').textContent = post.author || 'ìµëª…';
      $('#vDate').textContent = fmtDate(post.createdAt);
      $('#vViews').textContent = post.views;
      $('#vContent').textContent = post.content;

      currentId = id;
      renderComments(post);
      $('#page-view').classList.remove('hidden');
    }

    function renderComments(post){
      const listEl = $('#cmtList');
      const countEl = $('#cmtCount');
      const comments = (post.comments||[]).slice().sort((a,b)=>a.id-b.id);
      countEl.textContent = `(${comments.length})`;

      listEl.innerHTML = comments.map(c=>`
        <div class="cmt-item" data-cid="${c.id}">
          <div class="cmt-head">
            <div><span class="cmt-author">${escapeHtml(c.author||'ìµëª…')}</span> <span class="cmt-date">Â· ${fmtDateTime(c.createdAt)}</span></div>
            <div class="cmt-actions">
              <button class="page-btn" data-action="delete">ì‚­ì œ</button>
            </div>
          </div>
          <div class="cmt-body">${nl2br(c.content||'')}</div>
        </div>
      `).join('');

      // ëŒ“ê¸€ ì‚­ì œ
      $$('#cmtList .cmt-item .page-btn[data-action="delete"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const cid = Number(btn.closest('.cmt-item').dataset.cid);
          if(confirm('ì´ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){
            const p = db.find(currentId); if(!p) return;
            p.comments = (p.comments||[]).filter(x=>x.id!==cid);
            db.upsert(p); renderComments(p);
          }
        });
      });

      // ëŒ“ê¸€ ì‘ì„±
      const form = $('#cmtForm'), aEl = $('#cmtAuthor'), cEl = $('#cmtContent');
      form.onsubmit = e => { e.preventDefault(); addComment(currentId, aEl.value.trim()||'ìµëª…', cEl.value.trim()); };
      cEl.onkeydown = e => { if(e.key==='Enter' && (e.metaKey||e.ctrlKey)){ e.preventDefault(); addComment(currentId, aEl.value.trim()||'ìµëª…', cEl.value.trim()); } };
    }

    function addComment(postId, author, content){
      if(!content){ alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const post = db.find(postId); if(!post) return;
      if(!Array.isArray(post.comments)) post.comments=[];
      const nextCid = post.comments.length? Math.max(...post.comments.map(c=>c.id||0))+1 : 1;
      post.comments.push({ id: nextCid, author, content, createdAt: Date.now() });
      db.upsert(post);
      $('#cmtContent').value=''; renderComments(post);
    }

    /* ===== ì—ë””í„° ===== */
    const iptTitle=$('#iptTitle'), iptAuthor=$('#iptAuthor'), iptContent=$('#iptContent');
    let btnSave=$('#btnSave'), btnDelete=$('#btnDelete');

    function openEditor(id){
      const editing = !!id;
      const titleEl = $('#editorTitle');
      $('#page-editor').classList.remove('hidden');

      // ë²„íŠ¼ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”(ì¤‘ë³µ ë°©ì§€)
      btnSave.replaceWith(btnSave.cloneNode(true));
      btnDelete.replaceWith(btnDelete.cloneNode(true));
      btnSave = $('#btnSave'); btnDelete = $('#btnDelete');

      if(editing){
        const p = db.find(id);
        if(!p){ alert('ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return navigate('list'); }
        if(!Array.isArray(p.comments)) p.comments=[];
        iptTitle.value=p.title; iptAuthor.value=p.author||''; iptContent.value=p.content;
        titleEl.textContent='ê¸€ ìˆ˜ì •';
        btnDelete.classList.remove('hidden');
        btnDelete.onclick=()=>{ if(confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){ db.remove(id); navigate('list'); renderList(); } };
        btnSave.onclick=()=> savePost(id);
      }else{
        titleEl.textContent='ìƒˆ ê¸€ ì‘ì„±';
        btnDelete.classList.add('hidden');
        const draft = JSON.parse(localStorage.getItem(DRAFT_KEY)||'null');
        if(draft && confirm('ì´ì „ì— ì‘ì„± ì¤‘ì¸ ì´ˆì•ˆì„ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?')){
          iptTitle.value=draft.title||''; iptAuthor.value=draft.author||''; iptContent.value=draft.content||'';
        }else{
          localStorage.removeItem(DRAFT_KEY);
          iptTitle.value=''; iptAuthor.value=''; iptContent.value='';
        }
        btnSave.onclick=()=> savePost();
      }
      iptTitle.focus();

      // ìë™ ì´ˆì•ˆ ì €ì¥
      [iptTitle,iptAuthor,iptContent].forEach(el=> el.addEventListener('input', debounce(()=>{
        localStorage.setItem(DRAFT_KEY, JSON.stringify({title:iptTitle.value,author:iptAuthor.value,content:iptContent.value}));
      },300)));

      // ë‹¨ì¶•í‚¤ (ì—ë””í„°)
      document.onkeydown = e=>{
        const metaEnter=(e.key==='Enter'&&(e.metaKey||e.ctrlKey));
        const isEsc=(e.key==='Escape');
        if(metaEnter && !$('#page-editor').classList.contains('hidden')){ e.preventDefault(); btnSave.click(); }
        if(isEsc && !$('#page-editor').classList.contains('hidden')){ e.preventDefault(); $('#btnCancel').click(); }
      };
    }

    function validate(title, content){
      if(!title || !content){ alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
      if(title.length>120){ alert('ì œëª©ì€ 120ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
      return true;
    }

    function savePost(id){
      const title=iptTitle.value.trim();
      const author=iptAuthor.value.trim()||'ìµëª…';
      const content=iptContent.value.trim();
      if(!validate(title, content)) return;

      const now=Date.now();
      if(id){
        const p=db.find(id); if(!p) return;
        db.upsert({ id:p.id, title, author, content, createdAt:p.createdAt||now, updatedAt:now, views:p.views||0, comments:Array.isArray(p.comments)?p.comments:[] });
        renderList(); navigate('view/'+id);
      }else{
        const newId=db.nextId();
        db.upsert({ id:newId, title, author, content, createdAt:now, updatedAt:now, views:0, comments:[] });
        localStorage.removeItem(DRAFT_KEY);
        renderList(); navigate('view/'+newId);
      }
    }

    /* ===== ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ===== */
    $('#btnExport').addEventListener('click', ()=>{
      const blob=new Blob([db.export()],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pink-board.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#importFile').addEventListener('change', ev=>{
      const f=ev.target.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const mode = confirm('í™•ì¸=ë®ì–´ì“°ê¸°(ëª¨ë“  ë°ì´í„° êµì²´)\nì·¨ì†Œ=ë³‘í•©(ê¸°ì¡´+ê°€ì ¸ì˜¨ ë°ì´í„°)');
          db.import(reader.result, mode?'replace':'merge');
          alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
          navigate('list'); renderList();
        }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSONì´ ì•„ë‹™ë‹ˆë‹¤.'); }
      };
      reader.readAsText(f,'utf-8');
      ev.target.value='';
    });

    /* ===== ê³µí†µ ì´ë²¤íŠ¸ ===== */
    $('#goWrite').addEventListener('click',()=>navigate('write'));
    $('#goList').addEventListener('click',()=>navigate('list'));
    $('#btnCancel').addEventListener('click',()=>history.back());
    $('#btnBack').addEventListener('click',()=>navigate('list'));
    $('#btnEdit').addEventListener('click',()=>{ if(currentId!=null) navigate('edit/'+currentId); });
    $('#btnDeleteView').addEventListener('click',()=>{
      if(currentId==null) return;
      const p = db.find(currentId); if(!p) return;
      if(confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){ db.remove(currentId); currentId=null; navigate('list'); renderList(); }
    });

    const onSearch = debounce(e=>{ currentQuery=e.target.value; currentPage=1; saveUI(); renderList(); },250);
    $('#search').addEventListener('input', onSearch);
    $('#sort').addEventListener('change', e=>{ currentSort=e.target.value; saveUI(); renderList(); });

    // ì „ì—­ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', e=>{
      const k=e.key.toLowerCase();
      if(k==='n' && !$('#page-editor').classList.contains('hidden')) return;
      if(k==='n') navigate('write');
      if(k==='e' && !$('#page-view').classList.contains('hidden')) $('#btnEdit').click();
      if(k==='l') navigate('list');
    });

    // UI ìƒíƒœ ì €ì¥/ë³µì›
    function saveUI(){ localStorage.setItem(UI_KEY, JSON.stringify({q:currentQuery,sort:currentSort,page:currentPage})); }
    function restoreUI(){
      const ui=JSON.parse(localStorage.getItem(UI_KEY)||'null');
      if(ui){ currentQuery=ui.q||''; currentSort=ui.sort||'createdAt-desc'; currentPage=ui.page||1; $('#search').value=currentQuery; $('#sort').value=currentSort; }
    }

    // ì´ˆê¸° ì§„ì…
    if(!location.hash) navigate('list'); else handleRoute();
    window.addEventListener('load', handleRoute);
  </script>
</body>
</html>
