<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ëŒ€í™” ì±„íŒ…</title>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#ffffff; --text:#1f2330; --muted:#6c7280; --border:#e7e9ef;
      --accent:#1f6fff; --accent-weak:#eef3ff; --danger:#ff5c77; --ok:#16a34a;
      --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.06);
      --me:#1f6fff; --you:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:30px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}

    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;margin-bottom:14px}
    .title{font-weight:800}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.ghost{background:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .chat{display:grid;grid-template-rows:1fr auto;height:70vh}
    .messages{padding:16px;overflow:auto;scroll-behavior:smooth}
    .day{display:flex;gap:10px;align-items:center;justify-content:center;margin:16px 0;color:var(--muted);font-size:12px}
    .day::before,.day::after{content:"";flex:1;height:1px;background:var(--border)}

    .row{display:flex;gap:10px;margin:8px 0;align-items:flex-end}
    .row.me{justify-content:flex-end}
    .avatar{width:34px;height:34px;border-radius:50%;background:#eef1f6;color:#5b6577;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid var(--border)}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--you)}
    .row.me .bubble{background:var(--accent);border-color:var(--accent);color:#fff}
    .meta{margin-top:4px;font-size:11px;color:var(--muted);display:flex;gap:6px;align-items:center}
    .row.me .meta{justify-content:flex-end}
    .text{white-space:pre-wrap;line-height:1.6}
    .tools{opacity:0;display:flex;gap:6px}
    .row:hover .tools{opacity:1}
    .tool-btn{border:none;background:transparent;color:inherit;cursor:pointer;font-size:12px;text-decoration:underline}

    .composer{border-top:1px solid var(--border);padding:12px;display:grid;gap:8px}
    .controls{display:flex;gap:8px;align-items:center}
    .select, .input, .textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;color:var(--text);font-size:14px;outline:none}
    .textarea{resize:vertical;min-height:72px;max-height:40vh}
    .hint{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;background:var(--accent-weak);color:#26407b;border:1px dashed #d6e3ff;padding:4px 10px;border-radius:999px;font-size:12px}

    @media (max-width:600px){
      .bubble{max-width:82%}
      .avatar{display:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar card">
      <div class="title">ğŸ¤ ëŒ€í™” ì±„íŒ…</div>
      <div class="actions">
        <button id="btnExport" class="btn ghost" title="JSON ë‚´ë³´ë‚´ê¸°">ë‚´ë³´ë‚´ê¸°</button>
        <label for="importFile" class="btn ghost" title="JSON ë¶ˆëŸ¬ì˜¤ê¸°" style="cursor:pointer">ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button id="btnClear" class="btn danger">ì „ì²´ ì‚­ì œ</button>
      </div>
    </div>

    <section class="card chat">
      <div id="messages" class="messages"></div>

      <div class="composer">
        <div class="controls">
          <select id="role" class="select">
            <option value="me">ë‚˜</option>
            <option value="you">ìƒëŒ€</option>
          </select>
          <span class="pill">Enter ì „ì†¡ Â· Shift+Enter ì¤„ë°”ê¿ˆ</span>
        </div>
        <textarea id="input" class="textarea" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnSend" class="btn primary">ì „ì†¡</button>
        </div>
        <div class="hint">Tip: ë©”ì‹œì§€ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ <b>ìˆ˜ì • / ì‚­ì œ / ë³µì‚¬</b>ê°€ ë³´ì—¬ìš”. ë”ë¸”í´ë¦­ìœ¼ë¡œë„ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.</div>
      </div>
    </section>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const DB_KEY='white-chat-v1';

    // ===== ìœ í‹¸ =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = s => s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const fmtTime = ts => {
      const d=new Date(ts); const h=String(d.getHours()).padStart(2,'0'); const m=String(d.getMinutes()).padStart(2,'0'); return `${h}:${m}`;
    };
    const fmtDay = ts => {
      const d=new Date(ts);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };

    // ===== ì €ì¥ì†Œ =====
    const store = {
      all(){ return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); },
      save(list){ localStorage.setItem(DB_KEY, JSON.stringify(list)); },
      nextId(){ const list=this.all(); return list.length? Math.max(...list.map(m=>m.id))+1 : 1; },
      add(msg){ const list=this.all(); list.push(msg); this.save(list); },
      upsert(msg){ const list=this.all(); const i=list.findIndex(m=>m.id===msg.id); if(i>=0) list[i]=msg; else list.push(msg); this.save(list); },
      remove(id){ this.save(this.all().filter(m=>m.id!==id)); },
      clear(){ localStorage.removeItem(DB_KEY); },
      export(){ return JSON.stringify(this.all(), null, 2); },
      import(json, mode='merge'){ // 'replace'|'merge'
        const incoming = JSON.parse(json);
        if(!Array.isArray(incoming)) throw new Error('ì˜¬ë°”ë¥¸ JSON ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
        if(mode==='replace'){ this.save(incoming); return; }
        const map = new Map(this.all().map(m=>[m.id, m]));
        for(const m of incoming){ map.set(m.id, m); }
        this.save([...map.values()].sort((a,b)=>a.id-b.id));
      }
    };

    // ===== ë Œë”ë§ =====
    function render(){
      const box = $('#messages');
      const list = store.all().sort((a,b)=>a.createdAt-b.createdAt);
      let html = '';
      let lastDay = '';

      for(const m of list){
        const day = fmtDay(m.createdAt);
        if(day !== lastDay){
          html += `<div class="day">${day}</div>`;
          lastDay = day;
        }
        const me = m.role === 'me';
        const initials = me ? 'ë‚˜' : 'ìƒëŒ€';
        html += `
          <div class="row ${me?'me':'you'}" data-id="${m.id}">
            ${me? '' : `<div class="avatar">${escapeHtml(initials)}</div>`}
            <div>
              <div class="bubble">
                <div class="text">${escapeHtml(m.text)}</div>
              </div>
              <div class="meta">
                <span>${me?'ë‚˜':'ìƒëŒ€'}</span>
                <span>Â· ${fmtTime(m.createdAt)}</span>
                <span class="tools">
                  <button class="tool-btn" data-act="edit">ìˆ˜ì •</button>
                  <button class="tool-btn" data-act="copy">ë³µì‚¬</button>
                  <button class="tool-btn" data-act="delete" style="color:#c62828">ì‚­ì œ</button>
                </span>
              </div>
            </div>
            ${me? `<div class="avatar" title="ë‚˜">ë‚˜</div>` : ''}
          </div>
        `;
      }
      box.innerHTML = html || `<div class="day">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ë³´ì„¸ìš”</div>`;
      attachRowEvents();
      scrollToBottom();
    }

    function attachRowEvents(){
      $$('#messages .row').forEach(row=>{
        row.addEventListener('dblclick', ()=> startEdit(row.dataset.id));
        row.querySelectorAll('.tool-btn').forEach(btn=>{
          const act = btn.dataset.act;
          if(act==='edit') btn.addEventListener('click', ()=> startEdit(row.dataset.id));
          if(act==='delete') btn.addEventListener('click', ()=> deleteMsg(row.dataset.id));
          if(act==='copy') btn.addEventListener('click', ()=> copyMsg(row.dataset.id));
        });
      });
    }

    function scrollToBottom(){
      const box = $('#messages');
      box.scrollTop = box.scrollHeight;
    }

// ===== ì•¡ì…˜ =====
// ì¶”ê°€: ì´ˆë‹¨ê¸° ì¤‘ë³µ ë°©ì§€ìš© ìƒíƒœ
let __lastSend = { text: '', ts: 0 };

function send(){
  const role = $('#role').value;
  const text = $('#input').value.replace(/\r\n/g,"\n").trim();
  if(!text) return;

  // --- ì¶”ê°€: ê°™ì€ ë‚´ìš©ì´ 400ms ì•ˆì— ë˜ ì˜¤ë©´ ë¬´ì‹œ
  const now = Date.now();
  if (__lastSend.text === text && (now - __lastSend.ts) < 400) return;
  __lastSend = { text, ts: now };
  // ---

  const msg = { id: store.nextId(), role, text, createdAt: now };
  store.add(msg);
  $('#input').value = '';
  render();
}

    function startEdit(id){
      id = Number(id);
      const list = store.all();
      const m = list.find(x=>x.id===id);
      if(!m) return;
      const edited = prompt('ë©”ì‹œì§€ ìˆ˜ì •', m.text);
      if(edited==null) return; // cancel
      const text = edited.trim();
      if(!text){ if(confirm('ë¹ˆ ë©”ì‹œì§€ì…ë‹ˆë‹¤. ì‚­ì œí• ê¹Œìš”?')){ deleteMsg(id); } return; }
      store.upsert({ ...m, text });
      render();
    }

    function deleteMsg(id){
      id = Number(id);
      if(!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      store.remove(id); render();
    }

    async function copyMsg(id){
      id = Number(id);
      const m = store.all().find(x=>x.id===id);
      if(!m) return;
      try{ await navigator.clipboard.writeText(m.text); alert('í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”!'); }
      catch(e){ alert('ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
    }

   // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
$('#btnSend').addEventListener('click', send);

$('#input').addEventListener('keydown', (e)=>{
  // --- ì¶”ê°€: í•œê¸€/ì¼ë³¸ì–´ ì…ë ¥ í™•ì • ì¤‘ EnterëŠ” ë¬´ì‹œ + ê¸¸ê²Œ ëˆ„ë¥¸ ë°˜ë³µí‚¤ ë¬´ì‹œ
  if (e.isComposing || e.repeat) return;
  // ---
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    send();
  }
});


    $('#btnClear').addEventListener('click', ()=>{
      if(!store.all().length) return;
      if(confirm('ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')){ store.clear(); render(); }
    });

    $('#btnExport').addEventListener('click', ()=>{
      const blob = new Blob([store.export()], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'white-chat.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#importFile').addEventListener('change', ev=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const mode = confirm('í™•ì¸=ë®ì–´ì“°ê¸°(ê¸°ì¡´ ì‚­ì œ)\nì·¨ì†Œ=ë³‘í•©(ID ê¸°ì¤€ ë®ì–´ì“°ê¸°)');
          store.import(reader.result, mode?'replace':'merge');
          alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
          render();
        }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSONì´ ì•„ë‹™ë‹ˆë‹¤.'); }
      };
      reader.readAsText(f, 'utf-8');
      ev.target.value='';
    });

    // ===== ì´ˆê¸° ë Œë” =====
    render();
  </script>
</body>
</html>
